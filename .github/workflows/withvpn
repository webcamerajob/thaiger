name: Parse & Post Articles
concurrency:
Â  group: post-articles
Â  cancel-in-progress: false
Â Â 
permissions:
Â  contents: write
on:
Â  push:
Â  Â  branches: [ main ]
Â  workflow_dispatch:
Â  schedule:
Â  Â  - cron: '30 22 * * *'Â  # 5:30 UTC+7
Â  Â  #- cron: '0 23 * * *'Â  Â # 6:00
Â  Â  #- cron: '30 23 * * *'Â  # 6:30
Â  Â  #- cron: '0 0 * * *'Â  Â  # 7:00
Â  Â  - cron: '30 0 * * *'Â  Â # 7:30
Â  Â  #- cron: '0 1 * * *'Â  Â  # 8:00
Â  Â  #- cron: '30 1 * * *'Â  Â # 8:30
Â  Â  #- cron: '0 2 * * *'Â  Â  # 9:00
Â  Â  - cron: '30 2 * * *'Â  Â # 9:30
Â  Â  #- cron: '0 3 * * *'Â  Â  # 10:00
Â  Â  #- cron: '30 3 * * *'Â  Â # 10:30
Â  Â  #- cron: '0 4 * * *'Â  Â  # 11:00
Â  Â  - cron: '30 4 * * *'Â  Â # 11:30
Â  Â  #- cron: '0 5 * * *'Â  Â  # 12:00
Â  Â  #- cron: '30 5 * * *'Â  Â # 12:30
Â  Â  #- cron: '0 6 * * *'Â  Â  # 13:00
Â  Â  - cron: '30 6 * * *'Â  Â # 13:30
Â  Â  #- cron: '0 7 * * *'Â  Â  # 14:00
Â  Â  #- cron: '30 7 * * *'Â  Â # 14:30
Â  Â  #- cron: '0 8 * * *'Â  Â  # 15:00
Â  Â  - cron: '30 8 * * *'Â  Â # 15:30
Â  Â  #- cron: '0 9 * * *'Â  Â  # 16:00
Â  Â  #- cron: '30 9 * * *'Â  Â # 16:30
Â  Â  #- cron: '0 10 * * *'Â  Â # 17:00
Â  Â  #- cron: '30 10 * * *'Â  # 17:30
Â  Â  #- cron: '0 11 * * *'Â  Â # 18:00
Â  Â  #- cron: '30 11 * * *'Â  # 18:30
Â  Â Â 
env:
Â  POST_DELAY: 10
Â  BATCH_LIMIT: 15

jobs:

Â  parse:
Â  Â  name: ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ â†’ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ (WireGuard)
Â  Â  runs-on: ubuntu-latest
Â  Â  # Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: Ğ¡ĞµĞºÑ†Ğ¸Ñ outputs Ğ´Ğ»Ñ Ğ´Ğ¶Ğ¾Ğ±Ğ° parse
Â  Â  outputs:
Â  Â  Â  new_articles_found: ${{ steps.parse_step.outputs.new_articles_found }} # ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´ ÑˆĞ°Ğ³Ğ° ĞºĞ°Ğº Ğ²Ñ‹Ñ…Ğ¾Ğ´ Ğ´Ğ¶Ğ¾Ğ±Ğ°
Â  Â  env:
Â  Â  Â  WG_CONFIG: ${{ secrets.WG_CONFIG }}

Â  Â  steps:
Â  Â  Â  - name: Checkout code
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  - name: Set up Python
Â  Â  Â  Â  uses: actions/setup-python@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  python-version: '3.x'

Â  Â  Â  - name: Cache pip
Â  Â  Â  Â  uses: actions/cache@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  path: ~/.cache/pip
Â  Â  Â  Â  Â  key: ${{ runner.os }}-pip-${{ hashFiles('requirements-parser.txt') }}
Â  Â  Â  Â  Â  restore-keys: |
Â  Â  Â  Â  Â  Â  ${{ runner.os }}-pip-

Â  Â  Â  - name: Install parser requirements
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  if [ -f requirements-parser.txt ]; then
Â  Â  Â  Â  Â  Â  pip install -r requirements-parser.txt
Â  Â  Â  Â  Â  fi

#Â  Â  Â  - name: ğŸ” Setup WireGuard & install jq
#Â  Â  Â  Â  run: |
#Â  Â  Â  Â  Â  sudo apt-get update \
#Â  Â  Â  Â  Â  Â  && sudo apt-get install -y wireguard-tools resolvconf curl jq
#Â  Â  Â  Â  Â  mkdir -p $HOME/wg
#Â  Â  Â  Â  Â  # ĞŸĞ¸ÑˆĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ, Ğ±ĞµĞ· base64â€decode
#Â  Â  Â  Â  Â  echo "$WG_CONFIG" > $HOME/wg/wg0.conf
#Â  Â  Â  Â  Â  chmod 600 $HOME/wg/wg0.conf
#Â  Â  Â  Â  Â  sudo wg-quick up $HOME/wg/wg0.conf
#Â  Â  Â  Â  Â  echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
Â Â 
Â  Â  Â  # ====================================================================
Â  Â  Â  # ĞĞĞ’Ğ«Ğ™/Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞĞ«Ğ™ Ğ‘Ğ›ĞĞš: Run parser
Â  Â  Â  # ====================================================================
Â  Â  Â  - name: Run parser
Â  Â  Â  Â  id: parse_step # <-- ID Ğ´Ğ»Ñ ÑˆĞ°Ğ³Ğ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğº Ğ½ĞµĞ¼Ñƒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°Ñ‚ÑŒÑÑ
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "â†’ STARTING PARSER RUN" # ĞœĞ°Ñ€ĞºĞµÑ€ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ°
Â  Â  Â  Â  Â  # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ğ°Ñ€ÑĞµÑ€, ĞµĞ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¸ Ğ¸Ğ´ÑƒÑ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Ğ¸ Ğ² Ñ„Ğ°Ğ¹Ğ»
Â  Â  Â  Â  Â  python3 -u main.py \
Â  Â  Â  Â  Â  Â  --lang ${{ inputs.lang || 'ru' }} \
Â  Â  Â  Â  Â  Â  --limit ${{ env.BATCH_LIMIT_PARSE || 15 }} \
Â  Â  Â  Â  Â  Â  --posted-state-file articles/posted.json | tee parser_output.txt

Â  Â  Â  Â  Â  echo "â†’ PARSER RUN COMPLETE" # ĞœĞ°Ñ€ĞºĞµÑ€ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ°
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞµĞ³Ğ¾ ĞºĞ°Ğº Ğ²Ñ‹Ñ…Ğ¾Ğ´ ÑˆĞ°Ğ³Ğ°
Â  Â  Â  Â  Â  # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ `tr -d '[:space:]'` Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»ÑŒĞ½Ñ‹Ñ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ½Ğ¾Ğ²ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ)
Â  Â  Â  Â  Â  NEW_ARTICLES_STATUS=$(grep "NEW_ARTICLES_STATUS:" parser_output.txt | cut -d: -f2 | tr -d '[:space:]') # <-- Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: tr -d '[:space:]'
Â  Â  Â  Â  Â  echo "new_articles_found=$NEW_ARTICLES_STATUS" >> $GITHUB_OUTPUT # <-- Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° ÑˆĞ°Ğ³Ğ°
Â  Â  Â  Â  Â  echo "Extracted new_articles_found status: '$NEW_ARTICLES_STATUS'" # <-- Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ» ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¸)
Â  Â  Â  # ====================================================================

#Â  Â  Â  - name: ğŸ›‘ Teardown WireGuard
#Â  Â  Â  Â  if: always()
#Â  Â  Â  Â  run: sudo wg-quick down $HOME/wg/wg0.conf || true

Â  Â  Â  - name: Debug all files
Â  Â  Â  Â  run: ls -R

Â  Â  Â  - name: Debug parser output
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "â†’ Tree of generated articles/:"
Â  Â  Â  Â  Â  ls -R articles

Â  Â  Â  - name: Upload parsed-content
Â  Â  Â  Â  uses: actions/upload-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  name: parsed-content
Â  Â  Â  Â  Â  path: articles/*

Â  post:
Â  Â  name: Publish new articles
Â  Â  needs: parse
Â  Â  runs-on: ubuntu-latest
Â  Â  env:
Â  Â  Â  TELEGRAM_TOKEN:Â  Â ${{ secrets.TELEGRAM_TOKEN }}
Â  Â  Â  TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}

Â  Â  steps:
Â  Â  Â  - name: Checkout repo (contains empty catalog.json)
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  fetch-depth: 0
Â  Â  Â  Â  Â  persist-credentials: true

Â  Â  Â  - name: Set up Python for poster
Â  Â  Â  Â  uses: actions/setup-python@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  python-version: '3.x'

Â  Â  Â  - name: Cache pip
Â  Â  Â  Â  uses: actions/cache@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  path: ~/.cache/pip
Â  Â  Â  Â  Â  key: ${{ runner.os }}-pip-${{ hashFiles('requirements-poster.txt') }}
Â  Â  Â  Â  Â  restore-keys: |
Â  Â  Â  Â  Â  Â  ${{ runner.os }}-pip-
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  - name: Install poster requirements
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  pip install -r requirements-poster.txt

Â  Â  Â  - name: Download parsed-content
Â  Â  Â  Â  uses: actions/download-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  name: parsed-content
Â  Â  Â  Â  Â  path: parsed_articles

Â  Â  Â  - name: Debug parsed_articles
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "â†’ Tree of parsed_articles/:"
Â  Â  Â  Â  Â  ls -R parsed_articles

Â  Â  Â  # ====================================================================
Â  Â  Â  # ĞĞĞ’Ğ«Ğ™/Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞĞ«Ğ™ Ğ‘Ğ›ĞĞš: Run poster
Â  Â  Â  # ====================================================================
Â  Â  Â  - name: Debug extracted status
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  # Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ: Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑÑ‹Ğ»Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° needs.parse.outputs.new_articles_found
Â  Â  Â  Â  Â  echo "Value of new_articles_found from parse_step: '${{ needs.parse.outputs.new_articles_found }}'"
Â  Â  Â  Â  Â  echo "Comparison result: ${{ needs.parse.outputs.new_articles_found == 'true' }}"
Â  Â  Â  - name: Run poster
Â  Â  Â  Â  # Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ: Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑÑÑ‹Ğ»Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° needs.parse.outputs.new_articles_found
Â  Â  Â  Â  if: needs.parse.outputs.new_articles_found == 'true'Â 
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "â†’ Running poster against parsed_articles"
Â  Â  Â  Â  Â  python3 poster.py \
Â  Â  Â  Â  Â  Â  --parsed-dir parsed_articles \
Â  Â  Â  Â  Â  Â  --state-file articles/posted.json \
Â  Â  Â  Â  Â  Â  --limit $BATCH_LIMIT
Â  Â  Â  # ====================================================================

Â  Â  Â  - name: Debug articles after poster
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "â†’ Tree of articles/ after poster run:"
Â  Â  Â  Â  Â  ls -R articles

Â  Â  Â  - name: Commit updated posted.json
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  git config user.name "github-actions[bot]"
Â  Â  Â  Â  Â  git config user.email "github-actions[bot]@users.noreply.github.com"

Â  Â  Â  Â  Â  git add articles/posted.json
Â  Â  Â  Â  Â  if ! git diff --cached --quiet; then
Â  Â  Â  Â  Â  Â  git commit -m "chore: update posted catalog after posting"

Â  Â  Â  Â  Â  Â  # ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾Ğ³Ğ¾ main Ğ¸ Ñ€ĞµĞ±ĞµĞ¹Ğ·Ğ¸Ğ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ñ‹
Â  Â  Â  Â  Â  Â  git pull --rebase origin main

Â  Â  Â  Â  Â  Â  git push
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "âœ… posted.json unchanged"
Â  Â  Â  Â  Â  fi
